{% extends 'Universal.html' %}
{% load static %}

{% block title %}Catálogo de Peças | AutoIta{% endblock %}

{% block style_links %}
<link rel="stylesheet" href="{% static 'css/BasicoCSS.css' %}">
<link rel="stylesheet" href="{% static 'css/CatalogCSS.css' %}">
<link rel="stylesheet" href="{% static 'Modos/Claro/ClaroCatalog.css' %}" id="temas">
{% endblock %}

{% block conteudo %}
<button class="muda_tema">Mudar Tema</button>

<script>
    const botao = document.querySelector(".muda_tema");
    const tema = document.querySelector("#temas");
    const lightTheme = "{% static 'Modos/Claro/ClaroCatalog.css' %}";
    const darkTheme = "{% static 'Modos/Escuro/EscuroCatalog.css' %}";

    function applyInitialTheme() {
        const currentTheme = localStorage.getItem("theme");
        if (currentTheme === "dark") {
            tema.href = darkTheme;
        } else {
            tema.href = lightTheme;
        }
    }

    applyInitialTheme();

    botao.addEventListener("click", function() {
        if (tema.getAttribute("href") == lightTheme) {
            tema.href = darkTheme;
            localStorage.setItem("theme", "dark");
        } else {
            tema.href = lightTheme;
            localStorage.setItem("theme", "light");
        }
    });
</script>

<div class="catalog-container">
    <h1>Catálogo de Peças Automotivas</h1>

    <div class="controls-container">
        <div class="filters">
            <div class="filter-item">
                <label for="categoria">Categoria:</label>
                <select id="categoria" class="filter-select">
                    <option value="">Todas as categorias</option>
                    {% for categoria in categorias %}
                    <option value="{{ categoria.id_categoria }}">{{ categoria.nome_categoria }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-item">
                <label for="marca">Marca:</label>
                <select id="marca" class="filter-select">
                    <option value="">Todas as marcas</option>
                    {% for marca in marcas %}
                    <option value="{{ marca.id_marca }}">{{ marca.nome_marca }}</option>
                    {% endfor %}
                </select>
            </div>

            <button id="apply-filters" class="btn btn-filter">Aplicar filtros</button>
        </div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Buscar peças...">
            <button id="search-button" class="btn btn-search">Buscar</button>
        </div>
    </div>

    <div class="produtos" id="produtos-container">
        {% for produto in produtos %}
        <div class="produto-card">
            <h3>{{ produto.nome }}</h3>
            <p>{{ produto.descricao|truncatechars:100 }}</p>
            <p>Categoria: {{ produto.id_categoria.nome_categoria }}</p>
            <p>Marca: {{ produto.id_marca.nome_marca }}</p>
            <p class="preco">Preço: R$ {{ produto.preco }}</p>
            <p class="estoque {% if produto.quantidade_estoque < 5 %}estoque-baixo{% endif %}">
                Estoque: {{ produto.quantidade_estoque }} unidades
            </p>
        </div>
        {% empty %}
        <p class="no-products-message">Nenhum produto encontrado.</p>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const applyFiltersBtn = document.getElementById('apply-filters');
        const searchBtn = document.getElementById('search-button');
        const searchInput = document.getElementById('search-input');
        
        applyFiltersBtn.addEventListener('click', function() {
            const categoria = document.getElementById('categoria').value;
            const marca = document.getElementById('marca').value;
            const searchTerm = searchInput.value;
            
            fetchProdutos(categoria, marca, searchTerm);
        });
        
        searchBtn.addEventListener('click', function() {
            const categoria = document.getElementById('categoria').value;
            const marca = document.getElementById('marca').value;
            const searchTerm = searchInput.value;
            
            fetchProdutos(categoria, marca, searchTerm);
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const categoria = document.getElementById('categoria').value;
                const marca = document.getElementById('marca').value;
                const searchTerm = searchInput.value;
                
                fetchProdutos(categoria, marca, searchTerm);
            }
        });
        
        function fetchProdutos(categoria, marca, searchTerm) {
            let url = '/api/produtos/?';
            
            if (categoria) {
                url += `categoria=${categoria}&`;
            }
            
            if (marca) {
                url += `marca=${marca}&`;
            }
            
            if (searchTerm) {
                url += `nome=${searchTerm}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    updateProdutosUI(data);
                })
                .catch(error => console.error('Error fetching produtos:', error));
        }
        
        function updateProdutosUI(data) {
            const container = document.getElementById('produtos-container');
            
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<p class="no-products-message">Nenhum produto encontrado.</p>';
                return;
            }
            
            data.forEach(produto => {
                const card = document.createElement('div');
                card.className = 'produto-card';
                
                const estoqueBaixo = produto.quantidade_estoque < 5 ? 'estoque-baixo' : '';
                
                card.innerHTML = `
                    <h3>${produto.nome}</h3>
                    <p>${produto.descricao ? produto.descricao.substring(0, 100) + '...' : ''}</p>
                    <p>Categoria: ${produto.nome_categoria}</p>
                    <p>Marca: ${produto.nome_marca}</p>
                    <p class="preco">Preço: R$ ${produto.preco}</p>
                    <p class="estoque ${estoqueBaixo}">
                        Estoque: ${produto.quantidade_estoque} unidades
                    </p>
                `;
                
                container.appendChild(card);
            });
        }
    });
</script>
{% endblock %}